<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.omcube.model.mapper.EPLeaveMangerMapper">

	<resultMap id="EPLeaveMap" type="com.omcube.model.po.EPLeaveInfoPO">

		<id column="UID" property="uid"></id>
		<id column="APPLY_NO" property="applyNo"></id>
		<result column="LEAVE_START_TIME" property="leaveStartTime" javaType="java.util.Date"></result>
		<result column="LEAVE_END_TIME" property="leaveEndTime" javaType="java.util.Date"></result>
		<result column="LEAVE_TYPE" property="leaveType" javaType="java.lang.String"></result>
		<result column="TIME_SHEET" property="timeSheet" javaType="java.lang.Double"></result>
		<result column="AUTH_FLOW" property="authFlow" javaType="java.lang.String"></result>
		<result column="AUTH_STATUS" property="authStatus" javaType="java.lang.String"></result>
		<result column="AUTH_VIEW" property="authView" javaType="java.lang.String"></result>
		<result column="ATTACHM" property="attachm" javaType="java.lang.String"></result>
		<result column="REMARK" property="remark" javaType="java.lang.String"></result>
		<result column="CREATED_BY" property="createdBy" javaType="java.lang.String"></result>
		<result column="CREATED_DATE" property="createdDate" javaType="java.util.Date"></result>
		<result column="UPDATED_BY" property="updatedBy" javaType="java.lang.String"></result>
		<result column="UPDATED_DATE" property="updatedDate" javaType="java.util.Date"></result>

	</resultMap>
	<!-- 通过请假的编号查询 -->
	<select id="queryLeaveInfo" parameterType="map"
		resultType="com.omcube.model.po.EPLeaveInfoPO">
		select *
		from
		EP_LEAVE_FLOW
		where
		UID = #{uid} and APPLY_NO = #{applyNo}
	</select>

	<!-- 请假详细信息的添加 -->
	<insert id="addLeaveInfo" parameterType="com.omcube.model.response.LeaveResponse">
		insert into
			EP_LEAVE_FLOW
		values(
			#{uid},
			#{applyNo},
			#{userNo},
			#{leaveStartTime},
			#{leaveEndTime},
			#{leaveType},
			#{timeSheet},
			#{authFlow},
			#{authStatus},
			#{authView},
			#{attachm},
			#{remark},
			#{createdBy},
			date_format(now(),'%y-%m-%d')
		)
	</insert>

	<!-- 请假详情列表的查询 -->
	<select id="queryLeaveList" parameterType="com.omcube.model.request.QueryLeaveRequest" resultType="com.omcube.model.response.LeaveResponse">
		select 
			l.APPLY_NO as applyNo,
			c.ORGAN_NO as organNo,
			c.DERP_NO as deptNo,
			o1.ORGAN_NAME as companyname,
			o2.ORGAN_NAME as deptname,
			c.USER_NO as userNo,
			c.CUST_NAME as custName,
			l.LEAVE_TYPE as LEAVE_TYPE,
			l.LEAVE_START_TIME as LEAVE_START_TIME,
			l.LEAVE_END_TIME as LEAVE_END_TIME,
			l.TIME_SHEET as TIME_SHEET,
			l.REMARK as remark,
			l.ATTACHM as attachm,
			l.CREATED_BY as createdBy,
			l.CREATED_DATE as createdDate
		from (select * from EP_CUST_INFO where ORGAN_NO = #{organNo}) c 
		inner join IFDP_SYS_ORGAN_BASE o1
		on c.ORGAN_NO = o1.ORGAN_NO 
		inner join IFDP_SYS_ORGAN_BASE o2 
		on c.DERP_NO = o2.ORGAN_NO 
		inner join EP_LEAVE_FLOW l
		on c.USER_NO=l.USER_NO 	 
		where l.UID=#{uid}
		<if test="userNo != null and userNo!=''">
			and c.USER_NO =#{userNo}
		</if>
			
		<if test="leaveStartTime != null and leaveStartTime != ''">
			and l.LEAVE_START_TIME &gt; #{leaveStartTime}
		</if>
			
		<if test="leaveEndTime != null and leaveEndTime != ''">
			and l.LEAVE_END_TIME &lt; #{leaveEndTime}
		</if>
			
	    order by l.APPLY_NO desc
	</select>
	
	<!-- 请假详情的查询 -->
	<select id="queryLeaveInfos" parameterType="com.omcube.model.request.QueryLeaveRequest" resultType="com.omcube.model.response.LeaveResponse">
		select 
			l.APPLY_NO AS applyNo,
			c.ORGAN_NO AS organNo,
			c.DERP_NO AS deptNo,
			o1.ORGAN_NAME AS companyname,
			o2.ORGAN_NAME AS deptname,
			c.USER_NO AS userNo,
			c.CUST_NAME AS custName,
			l.LEAVE_TYPE AS LEAVE_TYPE,
			l.LEAVE_START_TIME AS LEAVE_START_TIME,
			l.LEAVE_END_TIME AS LEAVE_END_TIME,
			l.TIME_SHEET AS TIME_SHEET,
			l.REMARK AS remark,
			l.ATTACHM AS attachm,
			l.CREATED_BY AS createdBy,
			l.CREATED_DATE AS createdDate
		from EP_CUST_INFO c
		inner join IFDP_SYS_ORGAN_BASE o1 
		on c.ORGAN_NO = o1.ORGAN_NO 
		inner join IFDP_SYS_ORGAN_BASE o2 
		on c.DERP_NO = o2.ORGAN_NO 
		inner join EP_LEAVE_FLOW l
		on c.USER_NO=l.USER_NO 	 
		where l.UID=#{uid} and c.USER_NO=#{userNo}
		
	</select>
	
	<!-- 请假详情的删除 -->
	<delete id="deleteLeaveInfo" parameterType="com.omcube.model.request.QueryLeaveRequest">
		delete from 
			EP_LEAVE_FLOW 
		where 
			APPLY_N0 = #{applyNo} and UID = #{uid}	
	</delete>
	
	<!-- 请假详情的修改 -->
	<update id="modifyLeaveInfo" parameterType="com.omcube.model.request.QueryLeaveRequest">
		update
			EP_LEAVE_FLOW
		set
			LEAVE_START_TIME = #{leaveStartTime},
			LEAVE_END_TIME = #{leaveEndTime},
			LEAVE_TYPE = #{leaveType},
			TIME_SHEET = #{timeSheet},
			ATTACHM = #{attachm},
			REMARK = #{remark}
		where
			UID = #{uid} and APPLY_N0 = #{applyNo}
	</update>
	

</mapper>